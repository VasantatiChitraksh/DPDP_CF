<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCAG 1.2.3 Audio Description Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }
        .test-section h2 {
            color: #333;
            margin-top: 0;
        }
        video {
            width: 300px;
            height: 200px;
            background: #000;
            margin: 10px 0;
        }
        .transcript {
            background: #e8f4f8;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border: 2px solid #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="runChecker()">Run WCAG 1.2.3 Checker</button>
        <button onclick="location.reload()">Reset Page</button>
    </div>

    <h1>WCAG 1.2.3 Audio Description Test Page</h1>
    <p>This page contains various video scenarios to test the WCAG 1.2.3 checker script.</p>

    <!-- COMPLIANT EXAMPLES -->
    <div class="test-section">
        <h2>‚úÖ COMPLIANT: Video with Audio Description Track</h2>
        <video controls>
            <source src="sample-video.mp4" type="video/mp4">
            <track kind="descriptions" src="audio-description.vtt" srclang="en" label="Audio Description">
            <track kind="captions" src="captions.vtt" srclang="en" label="English Captions">
            Your browser does not support the video tag.
        </video>
        <p>This video has an audio description track.</p>
    </div>

    <div class="test-section">
        <h2>‚úÖ COMPLIANT: Video with Transcript Alternative</h2>
        <video controls aria-describedby="transcript1">
            <source src="sample-video2.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div id="transcript1" class="transcript">
            <h3>Video Transcript</h3>
            <p><strong>00:00-00:05:</strong> A person walks into a modern office building.</p>
            <p><strong>00:05-00:10:</strong> They approach the reception desk where a friendly receptionist greets them.</p>
            <p><strong>00:10-00:15:</strong> The person shows their ID card and receives a visitor badge.</p>
        </div>
    </div>

    <div class="test-section">
        <h2>‚úÖ COMPLIANT: Video with Data Attribute</h2>
        <video controls data-audio-description="true">
            <source src="sample-video3.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <p>This video is marked as having audio description via data attribute.</p>
    </div>

    <!-- NON-COMPLIANT EXAMPLES -->
    <div class="test-section">
        <h2>‚ùå NON-COMPLIANT: Video without Audio Description or Alternative</h2>
        <video controls>
            <source src="sample-video4.mp4" type="video/mp4">
            <track kind="captions" src="captions.vtt" srclang="en" label="English Captions">
            Your browser does not support the video tag.
        </video>
        <p>This video only has captions but no audio description or transcript.</p>
    </div>

    <div class="test-section">
        <h2>‚ùå NON-COMPLIANT: Embedded Video Content</h2>
        <iframe width="300" height="200" src="https://www.youtube.com/embed/dQw4w9WgXcQ" 
                title="YouTube video player" frameborder="0"></iframe>
        <p>This embedded video has no accessibility features indicated.</p>
    </div>

    <div class="test-section">
        <h2>‚ùå NON-COMPLIANT: Object with Video Content</h2>
        <object data="sample-video5.mp4" type="video/mp4" width="300" height="200">
            <p>Your browser doesn't support embedded videos.</p>
        </object>
        <p>This object element contains video but has no audio description.</p>
    </div>

    <!-- EXEMPT EXAMPLES -->
    <div class="test-section">
        <h2>‚ö™ EXEMPT: Media Alternative for Text</h2>
        <p>The following video is a media alternative for the text content below:</p>
        <video controls aria-label="Video alternative for the text content">
            <source src="text-alternative-video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="transcript">
            <h3>Original Text Content</h3>
            <p>This is the original text content that the video above represents as a media alternative. 
            According to WCAG 1.2.3, when media serves as an alternative for text and is clearly labeled as such, 
            it doesn't require additional audio description.</p>
        </div>
    </div>

    <div class="test-section">
        <h2>‚ö™ EXEMPT: Live Video Stream</h2>
        <video controls data-live="true">
            <source src="live-stream.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <p>This is marked as a live video stream. WCAG 1.2.3 applies only to prerecorded content.</p>
    </div>

    <!-- EDGE CASES -->
    <div class="test-section">
        <h2>üîç EDGE CASE: Video with Nearby Transcript</h2>
        <video controls>
            <source src="sample-video6.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="transcript-nearby">
            <h3>Video Description</h3>
            <p>This transcript is near the video and should be detected by the checker as a media alternative.</p>
        </div>
    </div>

    <div class="test-section">
        <h2>üîç EDGE CASE: Multiple Audio Tracks (Potential Audio Description)</h2>
        <video controls id="multiAudioVideo">
            <source src="sample-video7.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <p>This video potentially has multiple audio tracks (simulated).</p>
        <script>
            // Simulate multiple audio tracks
            document.addEventListener('DOMContentLoaded', function() {
                const video = document.getElementById('multiAudioVideo');
                if (video.audioTracks) {
                    // This would be detected by the checker as having multiple audio tracks
                }
            });
        </script>
    </div>

    <!-- jQuery CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- WCAG 1.2.3 Checker Script -->
    <script>
// WCAG 1.2.3 Audio Description or Media Alternative Checker
// Production version - Clean and professional

(() => {
  'use strict';
  
  console.log('üîç WCAG 1.2.3 Checker initializing...');
  
  // Configuration
  const config = {
    highlightViolations: true,
    logViolations: true,
    showSummary: true,
    violationStyles: {
      video: { border: '3px solid #e74c3c', boxShadow: '0 0 8px #e74c3c' },
      media: { border: '3px solid #f39c12', boxShadow: '0 0 8px #f39c12' }
    }
  };
  
  // Violation tracking
  let violations = {
    videos: [],
    media: [],
    total: 0
  };
  
  // Safe jQuery execution
  function executeWithJQuery(callback) {
    if (typeof $ !== 'undefined') {
      callback();
    } else if (typeof jQuery !== 'undefined') {
      window.$ = jQuery;
      callback();
    } else {
      // Fallback to vanilla JS after short wait
      setTimeout(() => {
        if (typeof $ !== 'undefined' || typeof jQuery !== 'undefined') {
          if (typeof $ === 'undefined') window.$ = jQuery;
          callback();
        } else {
          executeWithVanillaJS();
        }
      }, 500);
    }
  }
  
  // Main WCAG checker with jQuery
  function runWCAGChecks() {
    console.log('üéØ Running WCAG 1.2.3 compliance check...');
    
    // Reset violations
    violations = { videos: [], media: [], total: 0 };
    
    try {
      checkVideoElements();
      checkMediaElements();
      displaySummary();
      
    } catch (error) {
      console.error('‚ùå Error during WCAG checks:', error);
      executeWithVanillaJS();
    }
  }
  
  // Check if element is clearly labeled as text alternative
  function isMediaAlternativeForText(element) {
    const $element = $(element);
    const ariaLabel = $element.attr('aria-label') || '';
    const title = $element.attr('title') || '';
    const nearbyText = $element.prev().text() + ' ' + $element.next().text();
    
    const textAlternativeKeywords = [
      'alternative', 'transcript', 'text version', 'text alternative',
      'audio description', 'described version', 'accessibility version'
    ];
    
    const combinedText = (ariaLabel + ' ' + title + ' ' + nearbyText).toLowerCase();
    
    return textAlternativeKeywords.some(keyword => 
      combinedText.includes(keyword.toLowerCase())
    );
  }
  
  // Check if video has audio description or media alternative
  function hasAudioDescriptionOrAlternative(videoElement) {
    const $video = $(videoElement);
    
    // Check for audio description tracks
    const audioDescriptionTrack = $video.find('track[kind="descriptions"]').length > 0;
    
    // Check for alternative audio track (multiple audio tracks might indicate audio description)
    const hasMultipleAudioTracks = videoElement.audioTracks && videoElement.audioTracks.length > 1;
    
    // Check for aria-describedby pointing to audio description
    const ariaDescribedBy = $video.attr('aria-describedby');
    let hasAriaDescription = false;
    if (ariaDescribedBy) {
      const describedElement = document.getElementById(ariaDescribedBy);
      if (describedElement) {
        const descriptionText = describedElement.textContent.toLowerCase();
        hasAriaDescription = descriptionText.includes('audio description') || 
                           descriptionText.includes('described version') ||
                           descriptionText.length > 50; // Assume lengthy description is alternative
      }
    }
    
    // Check for nearby transcript or alternative content
    const $container = $video.closest('div, section, article, figure');
    const hasNearbyTranscript = $container.find('[class*="transcript"], [id*="transcript"], [class*="alternative"], [id*="alternative"]').length > 0;
    
    // Check for data attributes indicating audio description
    const hasDataAD = $video.attr('data-audio-description') === 'true' || 
                      $video.attr('data-described') === 'true';
    
    return {
      hasAudioDescription: audioDescriptionTrack || hasMultipleAudioTracks || hasDataAD,
      hasAlternative: hasAriaDescription || hasNearbyTranscript,
      trackCount: $video.find('track').length,
      details: {
        audioDescriptionTrack,
        hasMultipleAudioTracks,
        hasAriaDescription,
        hasNearbyTranscript,
        hasDataAD
      }
    };
  }
  
  // Check video elements for WCAG 1.2.3 compliance
  function checkVideoElements() {
    $('video').each(function() {
      const $video = $(this);
      const videoElement = this;
      
      // Skip if this is clearly a media alternative for text
      if (isMediaAlternativeForText(videoElement)) {
        console.log('‚ÑπÔ∏è Video skipped - appears to be media alternative for text', videoElement);
        return;
      }
      
      // Skip if video has no visual content (audio-only, though this should be rare for video elements)
      const hasVisualContent = !$video.attr('data-audio-only');
      if (!hasVisualContent) return;
      
      // Check for prerecorded content (assume prerecorded unless explicitly marked as live)
      const isLive = $video.attr('data-live') === 'true' || 
                     $video.attr('data-broadcast') === 'true' ||
                     $video.hasClass('live-stream');
      
      if (isLive) {
        console.log('‚ÑπÔ∏è Live video detected - WCAG 1.2.3 applies to prerecorded content only', videoElement);
        return;
      }
      
      const accessibilityCheck = hasAudioDescriptionOrAlternative(videoElement);
      
      // Video needs either audio description OR media alternative
      if (!accessibilityCheck.hasAudioDescription && !accessibilityCheck.hasAlternative) {
        const violation = {
          element: videoElement,
          type: 'video',
          issue: 'Missing audio description or media alternative',
          src: $video.attr('src') || 'Embedded/source element',
          suggestion: 'Add audio description track, transcript, or media alternative',
          details: accessibilityCheck.details
        };
        
        violations.videos.push(violation);
        violations.total++;
        
        if (config.logViolations) {
          console.warn('üö® WCAG 1.2.3: Video missing audio description or alternative', {
            element: videoElement,
            src: violation.src,
            trackCount: accessibilityCheck.trackCount,
            details: accessibilityCheck.details
          });
        }
        
        if (config.highlightViolations) {
          highlightElement($video, 'video', 'Missing audio description or media alternative');
        }
      } else {
        console.log('‚úÖ Video has audio description or alternative', {
          element: videoElement,
          hasAudioDescription: accessibilityCheck.hasAudioDescription,
          hasAlternative: accessibilityCheck.hasAlternative
        });
      }
    });
  }
  
  // Check other media elements that might contain video content
  function checkMediaElements() {
    $('object, embed, iframe').each(function() {
      const $element = $(this);
      const tagName = this.tagName.toLowerCase();
      
      // Check if this might contain video content
      const src = $element.attr('src') || $element.attr('data') || '';
      const type = $element.attr('type') || '';
      
      const mightContainVideo = src.includes('video') || 
                               src.includes('youtube') || 
                               src.includes('vimeo') || 
                               src.includes('player') ||
                               type.includes('video') ||
                               $element.attr('data-video') === 'true';
      
      if (!mightContainVideo) return;
      
      // Skip if clearly labeled as media alternative for text
      if (isMediaAlternativeForText(this)) return;
      
      // Check for accessibility features
      const hasAccessibilityFeatures = $element.attr('aria-describedby') || 
                                      $element.attr('data-audio-description') === 'true' ||
                                      $element.attr('title')?.toLowerCase().includes('described') ||
                                      $element.closest('div, section').find('[class*="transcript"], [id*="transcript"]').length > 0;
      
      if (!hasAccessibilityFeatures) {
        const violation = {
          element: this,
          type: 'media',
          issue: `${tagName} with potential video content missing accessibility features`,
          src: src || 'No src/data attribute',
          suggestion: `Add audio description, transcript, or accessibility attributes for ${tagName}`
        };
        
        violations.media.push(violation);
        violations.total++;
        
        if (config.logViolations) {
          console.warn(`üö® WCAG 1.2.3: ${tagName} with video content may lack audio description`, {
            element: this,
            src: violation.src
          });
        }
        
        if (config.highlightViolations) {
          highlightElement($element, 'media', `${tagName} may need audio description`);
        }
      }
    });
  }
  
  // Highlight violation elements
  function highlightElement($element, type, message) {
    const styles = config.violationStyles[type];
    $element.css(styles);
    $element.attr('data-wcag-violation', message);
    
    // Add tooltip
    const existingTitle = $element.attr('title') || '';
    const wcagMessage = `WCAG 1.2.3: ${message}`;
    $element.attr('title', existingTitle ? `${existingTitle} | ${wcagMessage}` : wcagMessage);
  }
  
  // Display summary of findings
  function displaySummary() {
    if (config.showSummary) {
      console.log('üìä WCAG 1.2.3 Compliance Summary:');
      console.log(`   Videos: ${violations.videos.length} violations`);
      console.log(`   Media Elements: ${violations.media.length} violations`);
      console.log(`   Total: ${violations.total} violations found`);
      
      if (violations.total === 0) {
        console.log('‚úÖ No WCAG 1.2.3 violations detected!');
        console.log('‚ÑπÔ∏è All videos appear to have audio descriptions or media alternatives');
      } else {
        console.log('üîß Review highlighted elements and add:');
        console.log('   ‚Ä¢ Audio description tracks (<track kind="descriptions">)');
        console.log('   ‚Ä¢ Transcripts or text alternatives');
        console.log('   ‚Ä¢ Media alternatives clearly labeled as such');
      }
      
      // Provide helpful implementation tips
      console.log('\nüí° Implementation Tips:');
      console.log('   ‚Ä¢ Use <track kind="descriptions"> for audio descriptions');
      console.log('   ‚Ä¢ Provide transcripts near video content');
      console.log('   ‚Ä¢ Use aria-describedby to link to descriptions');
      console.log('   ‚Ä¢ Mark media alternatives with clear labels');
      console.log('   ‚Ä¢ Consider data-audio-description="true" attribute');
    }
  }
  
  // Vanilla JS fallback
  function executeWithVanillaJS() {
    console.log('üì± Using vanilla JavaScript fallback...');
    
    try {
      // Check video elements
      const videos = document.querySelectorAll('video');
      videos.forEach(video => {
        // Skip if media alternative for text
        const nearbyText = (video.previousElementSibling?.textContent || '') + 
                          (video.nextElementSibling?.textContent || '');
        if (nearbyText.toLowerCase().includes('alternative') || 
            nearbyText.toLowerCase().includes('transcript')) {
          return;
        }
        
        // Check for audio description track
        const hasDescriptionTrack = video.querySelector('track[kind="descriptions"]') !== null;
        
        // Check for nearby transcript
        const container = video.closest('div, section, article, figure');
        const hasTranscript = container && 
                             (container.querySelector('[class*="transcript"]') !== null ||
                              container.querySelector('[id*="transcript"]') !== null);
        
        if (!hasDescriptionTrack && !hasTranscript) {
          violations.videos.push({
            element: video,
            type: 'video',
            issue: 'Missing audio description or media alternative'
          });
          violations.total++;
          
          if (config.highlightViolations) {
            Object.assign(video.style, config.violationStyles.video);
            video.setAttribute('title', 'WCAG 1.2.3: Missing audio description or media alternative');
          }
        }
      });
      
      displaySummary();
      
    } catch (error) {
      console.error('‚ùå Error in vanilla JS fallback:', error);
    }
  }
  
  // Make function available globally
  window.runWCAGCheck = function() {
    executeWithJQuery(runWCAGChecks);
  };
  
})();

// Function to run the checker manually
function runChecker() {
    console.clear();
    console.log('üöÄ Running WCAG 1.2.3 Checker...');
    window.runWCAGCheck();
}
    </script>
</body>
</html>